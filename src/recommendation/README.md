# 高级人物推荐系统

## 概述

这是一个基于Milvus向量数据库的高级人物推荐系统，集成了多种先进的检索策略，提供高效、准确的人物推荐服务。

## 核心特性

### 🚀 多种检索策略

1. **集成检索 (Ensemble Search)** - 推荐策略
   - 综合多种检索策略的结果
   - 使用投票机制选择最佳结果
   - 提供置信度评分

2. **稠密向量检索 (Dense Vector Search)**
   - 基于语义相似度的深度检索
   - 使用预训练语言模型生成嵌入向量
   - 适合语义理解和概念匹配

3. **BM25稀疏向量检索 (BM25 Sparse Vector Search)**
   - 基于关键词匹配的精确检索
   - 使用BM25算法进行相关性评分
   - 适合精确词汇匹配

4. **混合检索 (Hybrid Search)**
   - 结合稠密向量和BM25的优势
   - 可调节权重平衡语义和关键词匹配
   - 提供更全面的检索结果

5. **语义分块检索 (Semantic Chunk Search)**
   - 将查询分解为多个语义片段
   - 分别检索后合并结果
   - 适合复杂查询的处理

6. **多字段检索 (Multi-field Search)**
   - 在不同字段上分别搜索
   - 支持角色名称、特征、传记等字段
   - 提供更精确的匹配

### 🎯 高级功能

- **并行处理**: 使用线程池并行执行多种检索策略
- **智能去重**: 自动去除重复结果并重新排序
- **性能监控**: 实时显示检索耗时和策略效果
- **策略对比**: 一键比较不同检索策略的效果
- **置信度评分**: 为每个结果提供置信度指标

## 技术架构

### 核心组件

```
高级人物推荐系统
├── 检索策略引擎
│   ├── 稠密向量检索
│   ├── BM25稀疏向量检索
│   ├── 混合检索
│   ├── 语义分块检索
│   ├── 多字段检索
│   └── 集成检索
├── 数据处理模块
│   ├── 查询预处理
│   ├── 文本分词
│   └── 结果去重
├── 性能优化模块
│   ├── 并行处理
│   ├── 缓存机制
│   └── 异步执行
└── 用户界面
    ├── 策略选择
    ├── 参数调节
    └── 结果展示
```

### 技术栈

- **向量数据库**: Milvus
- **嵌入模型**: Azure OpenAI Embeddings
- **BM25算法**: Milvus BM25EmbeddingFunction
- **Web框架**: Gradio
- **文本处理**: jieba分词
- **并发处理**: ThreadPoolExecutor

## 安装和配置

### 环境要求

```bash
# Python 3.8+
pip install pymilvus gradio jieba python-dotenv
```

### 环境变量配置

```bash
# .env文件
MILVUS_URI=http://10.1.15.222:19530
PYTHONPATH=/path/to/your/project
AZURE_OPENAI_API_KEY=your_api_key
AZURE_OPENAI_ENDPOINT=your_endpoint
AZURE_EMBEDDING_DEPLOYMENT=your_deployment
```

### BM25模型训练

```bash
# 训练BM25模型
cd src/utils
python train_bm25_character_model.py
```

## 使用方法

### 启动系统

```bash
cd src/recommendation
python character_recommendation_app.py
```

### 界面操作

1. **选择检索策略**: 从下拉菜单中选择合适的检索策略
2. **输入查询**: 输入人物特征描述
3. **调节参数**: 设置返回结果数量
4. **执行搜索**: 点击搜索按钮或策略对比按钮

### 查询示例

```
- 勇敢坚韧的英雄角色
- 性格勇敢，乐于助人的角色
- 幽默风趣的科幻角色
- 登山队队长
- 年轻缉毒警察
- 幽默的记者
- 复杂的反派角色
- 智慧型侦探
```

## 检索策略详解

### 1. 集成检索 (推荐)

**优势**:
- 综合多种策略的优势
- 提供最高的准确性和召回率
- 自动处理策略间的冲突

**适用场景**:
- 一般性查询
- 需要高准确性的场景
- 复杂的人物特征描述

### 2. 稠密向量检索

**优势**:
- 语义理解能力强
- 支持概念匹配
- 对同义词和近义词敏感

**适用场景**:
- 语义相关的查询
- 概念性描述
- 需要理解上下文

### 3. BM25稀疏向量检索

**优势**:
- 关键词匹配精确
- 计算效率高
- 对特定词汇敏感

**适用场景**:
- 精确关键词匹配
- 专业术语查询
- 需要快速响应的场景

### 4. 混合检索

**优势**:
- 结合语义和关键词匹配
- 可调节权重
- 平衡准确性和召回率

**适用场景**:
- 需要平衡语义和精确匹配
- 复杂查询
- 对结果质量要求高的场景

### 5. 语义分块检索

**优势**:
- 处理复杂查询
- 提高长查询的准确性
- 支持多主题查询

**适用场景**:
- 长文本查询
- 多主题描述
- 复杂人物特征

### 6. 多字段检索

**优势**:
- 精确字段匹配
- 支持结构化查询
- 提高特定字段的准确性

**适用场景**:
- 特定字段查询
- 结构化数据
- 需要精确匹配的场景

## 性能优化

### 并行处理

系统使用ThreadPoolExecutor实现并行检索，显著提升响应速度：

```python
with ThreadPoolExecutor(max_workers=4) as executor:
    futures = [executor.submit(strategy, query, top_k) for strategy in strategies]
```

### 智能缓存

- 查询结果缓存
- 嵌入向量缓存
- 模型加载缓存

### 异步处理

- 异步嵌入生成
- 异步数据库查询
- 异步结果处理

## 监控和调试

### 性能指标

- 检索耗时
- 结果数量
- 策略成功率
- 置信度分布

### 调试功能

- 策略对比分析
- 详细错误日志
- 性能分析报告

## 扩展性

### 添加新策略

```python
def new_search_strategy(query, top_k):
    # 实现新的检索策略
    pass

# 在ensemble_search中添加
strategies.append(new_search_strategy)
```

### 自定义权重

```python
# 在hybrid_search中调节权重
dense_weight = 0.7  # 稠密向量权重
bm25_weight = 0.3   # BM25权重
```

### 支持新字段

```python
# 在multi_field_search中添加新字段
new_field_results = search_in_field(query, "new_field", top_k)
```

## 故障排除

### 常见问题

1. **BM25模型加载失败**
   - 检查模型文件是否存在
   - 确认模型训练是否完成

2. **Milvus连接失败**
   - 检查网络连接
   - 确认Milvus服务状态

3. **嵌入生成失败**
   - 检查Azure OpenAI配置
   - 确认API密钥和端点

### 日志分析

系统提供详细的日志输出，包括：
- 检索策略执行情况
- 性能指标
- 错误信息
- 调试信息

## 未来规划

### 功能增强

- [ ] 支持多模态检索（图像+文本）
- [ ] 添加个性化推荐
- [ ] 支持实时学习
- [ ] 增加更多检索策略

### 性能优化

- [ ] GPU加速支持
- [ ] 分布式检索
- [ ] 智能缓存优化
- [ ] 查询优化

### 用户体验

- [ ] 可视化结果展示
- [ ] 交互式参数调节
- [ ] 历史查询记录
- [ ] 个性化设置

## 贡献指南

欢迎提交Issue和Pull Request来改进系统！

### 开发环境设置

```bash
git clone <repository>
cd rag_milvus_kb_project
pip install -r requirements.txt
```

### 代码规范

- 遵循PEP 8规范
- 添加类型注解
- 编写单元测试
- 更新文档

## 许可证

本项目采用MIT许可证，详见LICENSE文件。 